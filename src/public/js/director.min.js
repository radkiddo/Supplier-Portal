(function(w){function l(F,E,D,C){var B=0,A=0,z=0,D=(D||"(").toString(),C=(C||")").toString(),y;for(y=0;y<F.length;y++){var x=F[y];if(x.indexOf(D,B)>x.indexOf(C,B)||~x.indexOf(D,B)&&!~x.indexOf(C,B)||!~x.indexOf(D,B)&&~x.indexOf(C,B)){A=x.indexOf(D,B),z=x.indexOf(C,B);if(~A&&!~z||!~A&&~z){var k=F.slice(0,(y||1)+1).join(E);F=[k].concat(F.slice((y||1)+1))}B=(z>A?z:A)+1,y=0}else{B=0}}return F}function m(j,i){var B,A=0,z="";while(B=j.substr(A).match(/[^\w\d\- %@&]*\*[^\w\d\- %@&]*/)){A=B.index+B[0].length,B[0]=B[0].replace(/^\*/,"([_.()!\\ %@&a-zA-Z0-9-]+)"),z+=j.substr(0,B.index)+B[0]}j=z+=j.substr(A);var y=j.match(/:([^\/]+)/ig),x;if(y){x=y.length;for(var k=0;k<x;k++){j=j.replace(y[k],n(y[k],i))}}return j}function n(f,e,h){h=f;for(var g in e){if(e.hasOwnProperty(g)){h=e[g](f);if(h!==f){break}}}return h===f?"([._a-zA-Z0-9-]+)":h}function o(g,f,j){if(!g.length){return j()}var i=0;(function h(){f(g[i],function(a){a||a===!1?(j(a),j=function(){}):(i+=1,i===g.length?j():h())})})()}function p(f){var e=[];for(var h=0,g=f.length;h<g;h++){e=e.concat(f[h])}return e}function q(e,d){for(var f=0;f<e.length;f+=1){if(d(e[f],f,e)===!1){return}}}function u(){return v.hash===""||v.hash==="#"}Array.prototype.filter||(Array.prototype.filter=function(h,g){var x=[],k;for(var j=0,i=this.length;j<i;j++){j in this&&h.call(g,k=this[j],j,this)&&x.push(k)}return x}),Array.isArray||(Array.isArray=function(b){return Object.prototype.toString.call(b)==="[object Array]"});var v=document.location,t={mode:"modern",hash:v.hash,history:!1,check:function(){var b=v.hash;b!=this.hash&&(this.hash=b,this.onHashChanged())},fire:function(){this.mode==="modern"?this.history===!0?window.onpopstate():window.onhashchange():this.onHashChanged()},init:function(g,e){function i(f){for(var d=0,k=r.listeners.length;d<k;d++){r.listeners[d](f)}}var j=this;this.history=e,r.listeners||(r.listeners=[]);if("onhashchange" in window&&(document.documentMode===undefined||document.documentMode>7)){this.history===!0?setTimeout(function(){window.onpopstate=i},500):window.onhashchange=i,this.mode="modern"}else{var h=document.createElement("iframe");h.id="state-frame",h.style.display="none",document.body.appendChild(h),this.writeFrame(""),"onpropertychange" in document&&"attachEvent" in document&&document.attachEvent("onpropertychange",function(){event.propertyName==="location"&&j.check()}),window.setInterval(function(){j.check()},50),this.onHashChanged=i,this.mode="legacy"}r.listeners.push(g);return this.mode},destroy:function(e){if(!!r&&!!r.listeners){var d=r.listeners;for(var f=d.length-1;f>=0;f--){d[f]===e&&d.splice(f,1)}}},setHash:function(b){this.mode==="legacy"&&this.writeFrame(b),this.history===!0?(window.history.pushState({},document.title,b),this.fire()):v.hash=b[0]==="/"?b:"/"+b;return this},writeFrame:function(e){var d=document.getElementById("state-frame"),f=d.contentDocument||d.contentWindow.document;f.open(),f.write("<script>_hash = '"+e+"'; onload = parent.listener.syncHash;<script>"),f.close()},syncHash:function(){var b=this._hash;b!=v.hash&&(v.hash=b);return this},onHashChanged:function(){}},r=w.Router=function(b){if(this instanceof r){this.params={},this.routes={},this.methods=["on","once","after","before"],this.scope=[],this._methods={},this._insert=this.insert,this.insert=this.insertEx,this.historySupport=(window.history!=null?window.history.pushState:null)!=null,this.configure(),this.mount(b||{})}else{return new r(b)}};r.prototype.init=function(b){var d=this;this.handler=function(f){var e=f&&f.newURL||window.location.hash,g=d.history===!0?d.getPath():e.replace(/.*#/,"");d.dispatch("on",g)},t.init(this.handler,this.history);if(this.history===!1){u()&&b?v.hash=b:u()||d.dispatch("on",v.hash.replace(/^#/,""))}else{var c=u()&&b?b:u()?null:v.hash.replace(/^#/,"");c&&window.history.replaceState({},document.title,c),(c||this.run_in_init===!0)&&this.handler()}return this},r.prototype.explode=function(){var b=this.history===!0?this.getPath():v.hash;b.charAt(1)==="/"&&(b=b.slice(1));return b.slice(1,b.length).split("/")},r.prototype.setRoute=function(f,d,h){var g=this.explode();typeof f=="number"&&typeof d=="string"?g[f]=d:typeof h=="string"?g.splice(f,d,s):g=[f],t.setHash(g.join("/"));return g},r.prototype.insertEx=function(f,e,h,g){f==="once"&&(f="on",h=function(d){var c=!1;return function(){if(!c){c=!0;return d.apply(this,arguments)}}}(h));return this._insert(f,e,h,g)},r.prototype.getRoute=function(e){var d=e;if(typeof e=="number"){d=this.explode()[e]}else{if(typeof e=="string"){var f=this.explode();d=f.indexOf(e)}else{d=this.explode()}}return d},r.prototype.destroy=function(){t.destroy(this.handler);return this},r.prototype.getPath=function(){var b=window.location.pathname;b.substr(0,1)!=="/"&&(b="/"+b);return b},r.prototype.configure=function(d){d=d||{};for(var c=0;c<this.methods.length;c++){this._methods[this.methods[c]]=!0}this.recurse=d.recurse||this.recurse||!1,this.async=d.async||!1,this.delimiter=d.delimiter||"/",this.strict=typeof d.strict=="undefined"?!0:d.strict,this.notfound=d.notfound,this.resource=d.resource,this.history=d.html5history&&this.historySupport||!1,this.run_in_init=this.history===!0&&d.run_handler_in_init!==!1,this.every={after:d.after||null,before:d.before||null,on:d.on||null};return this},r.prototype.param=function(e,d){e[0]!==":"&&(e=":"+e);var f=new RegExp(e,"g");this.params[e]=function(b){return b.replace(f,d.source||d)}},r.prototype.on=r.prototype.route=function(f,e,h){var g=this;!h&&typeof e=="function"&&(h=e,e=f,f="on");if(Array.isArray(e)){return e.forEach(function(a){g.on(f,a,h)})}e.source&&(e=e.source.replace(/\\\//ig,"/"));if(Array.isArray(f)){return f.forEach(function(b){g.on(b.toLowerCase(),e,h)})}e=e.split(new RegExp(this.delimiter)),e=l(e,this.delimiter),this.insert(f,this.scope.concat(e),h)},r.prototype.dispatch=function(j,i,B){function k(){A.last=z.after,A.invoke(A.runlist(z),A,B)}var A=this,z=this.traverse(j,i,this.routes,""),y=this._invoked,x;this._invoked=!0;if(!z||z.length===0){this.last=[],typeof this.notfound=="function"&&this.invoke([this.notfound],{method:j,path:i},B);return !1}this.recurse==="forward"&&(z=z.reverse()),x=this.every&&this.every.after?[this.every.after].concat(this.last):[this.last];if(x&&x.length>0&&y){this.async?this.invoke(x,this,k):(this.invoke(x,this),k());return !0}k();return !0},r.prototype.invoke=function(h,f,x){var k=this;this.async?o(h,function j(b,a){if(Array.isArray(b)){return o(b,j,a)}typeof b=="function"&&b.apply(f,h.captures.concat(a))},function(){x&&x.apply(f,arguments)}):q(h,function i(a){if(Array.isArray(a)){return q(a,i)}if(typeof a=="function"){return a.apply(f,h.captures||[])}typeof a=="string"&&k.resource&&k.resource[a].apply(f,h.captures||[])})},r.prototype.traverse=function(J,I,H,G,F){function y(f){function h(d){for(var c=d.length-1;c>=0;c--){Array.isArray(d[c])?(h(d[c]),d[c].length===0&&d.splice(c,1)):F(d[c])||d.splice(c,1)}}function e(b){var j=[];for(var i=0;i<b.length;i++){j[i]=Array.isArray(b[i])?e(b[i]):b[i]}return j}if(!F){return f}var g=e(f);g.matched=f.matched,g.captures=f.captures,g.after=f.after.filter(F),h(g);return g}var E=[],D,C,B,A,z;if(I===this.delimiter&&H[J]){A=[[H.before,H[J]].filter(Boolean)],A.after=[H.after].filter(Boolean),A.matched=!0,A.captures=[];return y(A)}for(var x in H){if(H.hasOwnProperty(x)&&(!this._methods[x]||this._methods[x]&&typeof H[x]=="object"&&!Array.isArray(H[x]))){D=C=G+this.delimiter+x,this.strict||(C+="["+this.delimiter+"]?"),B=I.match(new RegExp("^"+C));if(!B){continue}if(B[0]&&B[0]==I&&H[x][J]){A=[[H[x].before,H[x][J]].filter(Boolean)],A.after=[H[x].after].filter(Boolean),A.matched=!0,A.captures=B.slice(1),this.recurse&&H===this.routes&&(A.push([H.before,H.on].filter(Boolean)),A.after=A.after.concat([H.after].filter(Boolean)));return y(A)}A=this.traverse(J,I,H[x],D);if(A.matched){A.length>0&&(E=E.concat(A)),this.recurse&&(E.push([H[x].before,H[x].on].filter(Boolean)),A.after=A.after.concat([H[x].after].filter(Boolean)),H===this.routes&&(E.push([H.before,H.on].filter(Boolean)),A.after=A.after.concat([H.after].filter(Boolean)))),E.matched=!0,E.captures=A.captures,E.after=A.after;return y(E)}}}return !1},r.prototype.insert=function(D,C,B,A){var z,y,x,k,j;C=C.filter(function(b){return b&&b.length>0}),A=A||this.routes,j=C.shift(),/\:|\*/.test(j)&&!/\\d|\\w/.test(j)&&(j=m(j,this.params));if(C.length>0){A[j]=A[j]||{};return this.insert(D,C,B,A[j])}if(!!j||!!C.length||A!==this.routes){y=typeof A[j],x=Array.isArray(A[j]);if(A[j]&&!x&&y=="object"){z=typeof A[j][D];switch(z){case"function":A[j][D]=[A[j][D],B];return;case"object":A[j][D].push(B);return;case"undefined":A[j][D]=B;return}}else{if(y=="undefined"){k={},k[D]=B,A[j]=k;return}}throw new Error("Invalid route context: "+y)}z=typeof A[D];switch(z){case"function":A[D]=[A[D],B];return;case"object":A[D].push(B);return;case"undefined":A[D]=B;return}},r.prototype.extend=function(g){function h(b){f._methods[b]=!0,f[b]=function(){var a=arguments.length===1?[b,""]:[b];f.on.apply(f,a.concat(Array.prototype.slice.call(arguments)))}}var f=this,j=g.length,i;for(i=0;i<j;i++){h(g[i])}},r.prototype.runlist=function(d){var c=this.every&&this.every.before?[this.every.before].concat(p(d)):p(d);this.every&&this.every.on&&c.push(this.every.on),c.captures=d.captures,c.source=d.source;return c},r.prototype.mount=function(g,f){function i(a,A){var z=a,y=a.split(j.delimiter),x=typeof g[a],k=y[0]===""||!j._methods[y[0]],c=k?"on":z;k&&(z=z.slice((z.match(new RegExp(j.delimiter))||[""])[0].length),y.shift());k&&x==="object"&&!Array.isArray(g[a])?(A=A.concat(y),j.mount(g[a],A)):(k&&(A=A.concat(z.split(j.delimiter)),A=l(A,j.delimiter)),j.insert(c,A,g[a]))}if(!!g&&typeof g=="object"&&!Array.isArray(g)){var j=this;f=f||[],Array.isArray(f)||(f=f.split(j.delimiter));for(var h in g){g.hasOwnProperty(h)&&i(h,f.slice(0))}}}})(typeof exports=="object"?exports:window);